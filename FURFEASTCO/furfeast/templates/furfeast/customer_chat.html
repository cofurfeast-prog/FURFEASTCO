{% extends 'furfeast/base.html' %}

{% block title %}Chat with Seller - FURFEAST CO.{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-4xl">
    <div class="bg-white rounded-2xl shadow-lg flex flex-col" style="height: calc(100vh - 200px); min-height: 500px;">
        <div class="bg-primary text-white px-4 sm:px-6 py-4 rounded-t-2xl flex items-center justify-between">
            <div>
                <h2 class="text-lg sm:text-xl font-bold">ðŸ’¬ Chat with Seller</h2>
                <p class="text-sm opacity-90" id="status-text">We're here to help!</p>
            </div>
            <div class="flex items-center gap-2">
                <span id="online-indicator" class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
                <span class="text-sm">Online</span>
            </div>
        </div>

        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-50">
            <div id="typing-indicator" class="hidden flex justify-start">
                <div class="bg-white rounded-lg px-4 py-3 shadow">
                    <div class="flex gap-1">
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                        <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                    </div>
                </div>
            </div>
            {% for msg in chat_messages %}
            <div class="flex {% if msg.is_from_admin %}justify-start{% else %}justify-end{% endif %}">
                <div class="max-w-xs sm:max-w-md {% if msg.is_from_admin %}bg-white{% else %}bg-primary text-white{% endif %} rounded-lg px-4 py-3 shadow">
                    {% if msg.image %}
                    <img src="{{ msg.image.url }}" alt="Attachment" class="rounded mb-2 max-w-full">
                    {% endif %}
                    {% if msg.message %}
                    <p class="text-sm">{{ msg.message }}</p>
                    {% endif %}
                    <p class="text-xs {% if msg.is_from_admin %}text-slate-500{% else %}text-orange-100{% endif %} mt-1">
                        {{ msg.created_at|date:"M d, g:i A" }}
                    </p>
                </div>
            </div>
            {% empty %}
            <div class="text-center text-slate-500 py-12">
                <p>No messages yet. Start a conversation!</p>
            </div>
            {% endfor %}
        </div>

        <form id="chat-form" class="p-4 border-t bg-white rounded-b-2xl">
            {% csrf_token %}
            <div class="flex gap-2">
                <input type="file" id="image-input" accept="image/*" class="hidden">
                <button type="button" id="attach-btn" class="p-2 sm:p-3 hover:bg-slate-100 rounded-full transition-colors text-xl">
                    ðŸ“Ž
                </button>
                <input type="text" id="message-input" name="message" placeholder="Type your message..." 
                       class="flex-1 px-4 py-2 border rounded-full focus:outline-none focus:ring-2 focus:ring-primary text-sm sm:text-base">
                <button type="submit" class="px-4 sm:px-6 py-2 bg-primary text-white rounded-full hover:bg-primary-dark transition-colors font-semibold text-sm sm:text-base">
                    Send
                </button>
            </div>
            <div id="image-preview" class="mt-2 hidden">
                <img id="preview-img" class="h-20 rounded-lg">
            </div>
        </form>
    </div>
</div>

<script>
const chatMessages = document.getElementById('chat-messages');
const chatForm = document.getElementById('chat-form');
const messageInput = document.getElementById('message-input');
const typingIndicator = document.getElementById('typing-indicator');
const statusText = document.getElementById('status-text');
const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/chat/`);

let typingTimeout;

ws.onopen = () => console.log('Customer connected to chat');

ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log('Customer received:', data);
    
    // Handle typing indicator
    if (data.typing !== undefined) {
        if (data.is_admin && data.typing) {
            typingIndicator.classList.remove('hidden');
            statusText.textContent = 'Typing...';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        } else {
            typingIndicator.classList.add('hidden');
            statusText.textContent = "We're here to help!";
        }
        return;
    }
    
    const msg = data;
    if (document.querySelector(`[data-msg-id="${msg.id}"]`)) return;
    
    const empty = chatMessages.querySelector('.text-center');
    if (empty) empty.remove();
    
    const div = document.createElement('div');
    div.className = `flex ${msg.is_from_admin ? 'justify-start' : 'justify-end'}`;
    div.setAttribute('data-msg-id', msg.id);
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-xs sm:max-w-md ${msg.is_from_admin ? 'bg-white' : 'bg-primary text-white'} rounded-lg px-4 py-3 shadow`;
    
    if (msg.message) {
        const p = document.createElement('p');
        p.className = 'text-sm';
        p.textContent = msg.message;
        bubble.appendChild(p);
    }
    
    const time = document.createElement('p');
    time.className = `text-xs ${msg.is_from_admin ? 'text-slate-500' : 'text-orange-100'} mt-1`;
    time.textContent = new Date(msg.created_at).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    bubble.appendChild(time);
    
    div.appendChild(bubble);
    chatMessages.appendChild(div);
    chatMessages.scrollTop = chatMessages.scrollHeight;
};

// Send typing indicator
messageInput.addEventListener('input', () => {
    clearTimeout(typingTimeout);
    ws.send(JSON.stringify({typing: true}));
    typingTimeout = setTimeout(() => {
        ws.send(JSON.stringify({typing: false}));
    }, 1000);
});

chatForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = messageInput.value.trim();
    if (!msg) return;
    clearTimeout(typingTimeout);
    ws.send(JSON.stringify({message: msg, typing: false}));
    messageInput.value = '';
});

ws.onerror = (error) => console.error('WebSocket error:', error);
ws.onclose = () => {
    console.log('WebSocket disconnected. Reconnecting in 3s...');
    setTimeout(() => location.reload(), 3000);
};

chatMessages.scrollTop = chatMessages.scrollHeight;
</script>
{% endblock %}
