{% extends 'furfeast/dashboard/base.html' %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col" style="height: calc(100vh - 200px);">
    <div class="p-4 border-b border-slate-200 flex items-center justify-between">
        <div class="flex items-center gap-3">
            <a href="{% url 'dashboard_customer_messages_list' %}" class="text-slate-600 hover:text-slate-900" onclick="sessionStorage.setItem('clearCache', Date.now());">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            {% if customer.profile.profile_picture %}
            <img src="{{ customer.profile.profile_picture.url }}" alt="{{ customer.first_name }}" class="w-10 h-10 rounded-full object-cover">
            {% else %}
            <div class="w-10 h-10 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold">
                {{ customer.first_name|first|upper }}
            </div>
            {% endif %}
            <div>
                <h2 class="font-semibold text-slate-900">{{ customer.first_name }} {{ customer.last_name }}</h2>
                <p class="text-sm text-slate-600" id="customer-status">{{ customer.email }}</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span id="customer-online" class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></span>
            <span class="text-sm text-slate-600">Online</span>
        </div>
    </div>

    <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4">
        <div id="customer-typing" class="hidden flex justify-start">
            <div class="bg-slate-100 rounded-lg px-4 py-3">
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                </div>
            </div>
        </div>
        {% for msg in chat_messages %}
        <div class="flex {% if msg.is_from_admin %}justify-end{% else %}justify-start{% endif %}" data-msg-id="{{ msg.id }}">
            <div class="max-w-md {% if msg.is_from_admin %}bg-orange-500 text-white{% else %}bg-slate-100 text-slate-900{% endif %} rounded-lg p-3">
                {% if msg.image %}
                <img src="{{ msg.image.url }}" alt="Attachment" class="rounded mb-2 max-w-xs">
                {% endif %}
                {% if msg.message %}
                <p class="text-sm">{{ msg.message }}</p>
                {% endif %}
                <p class="text-xs {% if msg.is_from_admin %}text-orange-100{% else %}text-slate-500{% endif %} mt-1">
                    {{ msg.created_at|date:"M d, g:i A" }}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>

    <form id="admin-chat-form" method="post" enctype="multipart/form-data" class="p-4 border-t border-slate-200">
        {% csrf_token %}
        <div class="flex gap-2">
            <input type="text" id="admin-message-input" name="message" placeholder="Type your message..." 
                   class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500">
            <label class="cursor-pointer px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors">
                ðŸ“Ž
                <input type="file" name="image" accept="image/*" class="hidden">
            </label>
            <button type="submit" class="px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors">
                Send
            </button>
        </div>
    </form>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const adminForm = document.getElementById('admin-chat-form');
const adminInput = document.getElementById('admin-message-input');
const customerTyping = document.getElementById('customer-typing');
const customerStatus = document.getElementById('customer-status');
const userId = {{ customer.id }};
const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/chat/?customer_id=${userId}`);

let typingTimeout;

ws.onopen = () => console.log('Admin connected to chat');

ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    console.log('Admin received:', data);
    
    // Handle typing indicator
    if (data.typing !== undefined) {
        if (!data.is_admin && data.typing) {
            customerTyping.classList.remove('hidden');
            customerStatus.textContent = 'Typing...';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } else {
            customerTyping.classList.add('hidden');
            customerStatus.textContent = '{{ customer.email }}';
        }
        return;
    }
    
    const msg = data;
    if (document.querySelector(`[data-msg-id="${msg.id}"]`)) return;
    
    const div = document.createElement('div');
    div.className = `flex ${msg.is_from_admin ? 'justify-end' : 'justify-start'}`;
    div.setAttribute('data-msg-id', msg.id);
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-md ${msg.is_from_admin ? 'bg-orange-500 text-white' : 'bg-slate-100 text-slate-900'} rounded-lg p-3`;
    
    const p = document.createElement('p');
    p.className = 'text-sm';
    p.textContent = msg.message;
    bubble.appendChild(p);
    
    const time = document.createElement('p');
    time.className = `text-xs ${msg.is_from_admin ? 'text-orange-100' : 'text-slate-500'} mt-1`;
    time.textContent = new Date(msg.created_at).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    bubble.appendChild(time);
    
    div.appendChild(bubble);
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;
};

// Send typing indicator
adminInput.addEventListener('input', () => {
    clearTimeout(typingTimeout);
    ws.send(JSON.stringify({typing: true, user_id: userId}));
    typingTimeout = setTimeout(() => {
        ws.send(JSON.stringify({typing: false, user_id: userId}));
    }, 1000);
});

adminForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const msg = adminInput.value.trim();
    if (!msg) return;
    clearTimeout(typingTimeout);
    ws.send(JSON.stringify({message: msg, user_id: userId, typing: false}));
    adminInput.value = '';
});

ws.onerror = (error) => console.error('WebSocket error:', error);
ws.onclose = () => {
    console.log('WebSocket disconnected. Reconnecting in 3s...');
    setTimeout(() => location.reload(), 3000);
};

chatContainer.scrollTop = chatContainer.scrollHeight;

// Force reload on back navigation
window.addEventListener('pageshow', (event) => {
    if (event.persisted || performance.getEntriesByType('navigation')[0].type === 'back_forward') {
        location.reload();
    }
});
</script>
{% endblock %}
