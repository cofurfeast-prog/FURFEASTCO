{% extends 'furfeast/dashboard/base.html' %}

{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col" style="height: calc(100vh - 150px); min-height: 400px;">
    <div class="p-3 sm:p-4 border-b border-slate-200 flex items-center justify-between flex-wrap gap-2">
        <div class="flex items-center gap-2 sm:gap-3 min-w-0 flex-1">
            <a href="{% url 'dashboard_customer_messages_list' %}" class="text-slate-600 hover:text-slate-900 flex-shrink-0" onclick="sessionStorage.setItem('clearCache', Date.now());">
                <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
            </a>
            {% if customer.profile.profile_picture %}
            <img src="{{ customer.profile.profile_picture.url }}" alt="{{ customer.first_name }}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover flex-shrink-0">
            {% else %}
            <div class="w-8 h-8 sm:w-10 sm:h-10 rounded-full bg-orange-500 flex items-center justify-center text-white font-bold text-sm sm:text-base flex-shrink-0">
                {{ customer.first_name|first|upper }}
            </div>
            {% endif %}
            <div class="min-w-0 flex-1">
                <h2 class="font-semibold text-slate-900 text-sm sm:text-base truncate">{{ customer.first_name }} {{ customer.last_name }}</h2>
                <p class="text-xs sm:text-sm text-slate-600 truncate" id="customer-status">{{ customer.email }}</p>
            </div>
        </div>
        <div class="flex items-center gap-2 flex-shrink-0">
            <span id="customer-online" class="w-2 h-2 sm:w-3 sm:h-3 bg-green-400 rounded-full animate-pulse"></span>
            <span class="text-xs sm:text-sm text-slate-600">Online</span>
        </div>
    </div>

    <div id="chat-container" class="flex-1 overflow-y-auto p-2 sm:p-4 space-y-3 sm:space-y-4">
        <div id="customer-typing" class="hidden flex justify-start">
            <div class="bg-slate-100 rounded-lg px-3 sm:px-4 py-2 sm:py-3">
                <div class="flex gap-1">
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    <span class="w-2 h-2 bg-slate-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                </div>
            </div>
        </div>
        <!-- Messages loaded from database on page load -->
        {% for msg in chat_messages %}
        <div class="flex {% if msg.is_from_admin %}justify-end{% else %}justify-start{% endif %}" data-msg-id="{{ msg.id }}">
            <div class="max-w-[85%] sm:max-w-md {% if msg.is_from_admin %}bg-orange-500 text-white{% else %}bg-slate-100 text-slate-900{% endif %} rounded-lg p-2 sm:p-3 break-words">
                {% if msg.image %}
                <img src="{{ msg.image.url }}" alt="Attachment" class="rounded mb-2 max-w-full">
                {% endif %}
                {% if msg.message %}
                <p class="text-xs sm:text-sm break-words">{{ msg.message }}</p>
                {% endif %}
                <p class="text-[10px] sm:text-xs {% if msg.is_from_admin %}text-orange-100{% else %}text-slate-500{% endif %} mt-1">
                    {{ msg.created_at|date:"M d, g:i A" }}
                </p>
            </div>
        </div>
        {% endfor %}
    </div>

    <form id="admin-chat-form" enctype="multipart/form-data" class="p-2 sm:p-4 border-t border-slate-200">
        {% csrf_token %}
        <div class="flex gap-1 sm:gap-2">
            <input type="text" id="admin-message-input" name="message" placeholder="Type message..." 
                   class="flex-1 min-w-0 px-3 sm:px-4 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-xs sm:text-base">
            <label class="cursor-pointer px-2 sm:px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 transition-colors flex-shrink-0 text-sm sm:text-base">
                üìé
                <input type="file" id="admin-image-input" name="image" accept="image/jpeg,image/jpg,image/png" class="hidden">
            </label>
            <button type="submit" class="px-3 sm:px-6 py-2 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transition-colors flex-shrink-0 text-xs sm:text-base">
                Send
            </button>
        </div>
        <div id="admin-image-preview" class="mt-2 hidden">
            <div class="relative inline-block">
                <img id="admin-preview-img" class="h-16 sm:h-20 rounded-lg">
                <button type="button" id="admin-remove-image" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">
                    ‚úï
                </button>
            </div>
        </div>
    </form>
</div>

<script>
const chatContainer = document.getElementById('chat-container');
const adminForm = document.getElementById('admin-chat-form');
const adminInput = document.getElementById('admin-message-input');
const adminImageInput = document.getElementById('admin-image-input');
const adminImagePreview = document.getElementById('admin-image-preview');
const adminPreviewImg = document.getElementById('admin-preview-img');
const adminRemoveImageBtn = document.getElementById('admin-remove-image');
const customerTyping = document.getElementById('customer-typing');
const customerStatus = document.getElementById('customer-status');
const userId = {{ customer.id }};
const ws = new WebSocket(`${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws/chat/?customer_id=${userId}`);

let typingTimeout;

// Image selection with validation
adminImageInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    // Validate file type
    if (!['image/jpeg', 'image/jpg', 'image/png'].includes(file.type)) {
        alert('Only JPEG and PNG images are allowed');
        adminImageInput.value = '';
        return;
    }
    
    // Validate file size (1MB)
    if (file.size > 1048576) {
        alert('Image size must be less than 1MB');
        adminImageInput.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        adminPreviewImg.src = e.target.result;
        adminImagePreview.classList.remove('hidden');
    };
    reader.readAsDataURL(file);
});

// Remove image
adminRemoveImageBtn.addEventListener('click', () => {
    adminImageInput.value = '';
    adminImagePreview.classList.add('hidden');
});

ws.onopen = () => {
    console.log('WebSocket connected');
    chatContainer.scrollTop = chatContainer.scrollHeight;
};

ws.onerror = (error) => console.error('WebSocket error:', error);

ws.onclose = () => console.log('WebSocket disconnected');

function renderMessage(msg) {
    // Prevent duplicates
    if (document.querySelector(`[data-msg-id="${msg.id}"]`)) return;
    
    const div = document.createElement('div');
    div.className = `flex ${msg.is_from_admin ? 'justify-end' : 'justify-start'}`;
    div.setAttribute('data-msg-id', msg.id);
    
    const bubble = document.createElement('div');
    bubble.className = `max-w-[85%] sm:max-w-md ${msg.is_from_admin ? 'bg-orange-500 text-white' : 'bg-slate-100 text-slate-900'} rounded-lg p-2 sm:p-3 break-words`;
    
    if (msg.image) {
        const img = document.createElement('img');
        img.src = msg.image;
        img.alt = 'Attachment';
        img.className = 'rounded mb-2 max-w-full';
        bubble.appendChild(img);
    }
    
    if (msg.message) {
        const p = document.createElement('p');
        p.className = 'text-xs sm:text-sm break-words';
        p.textContent = msg.message;
        bubble.appendChild(p);
    }
    
    const time = document.createElement('p');
    time.className = `text-[10px] sm:text-xs ${msg.is_from_admin ? 'text-orange-100' : 'text-slate-500'} mt-1`;
    time.textContent = new Date(msg.created_at).toLocaleString('en-US', {month:'short',day:'numeric',hour:'numeric',minute:'2-digit',hour12:true});
    bubble.appendChild(time);
    
    div.appendChild(bubble);
    chatContainer.appendChild(div);
}

ws.onmessage = (e) => {
    const data = JSON.parse(e.data);
    
    if (data.typing !== undefined) {
        if (!data.is_admin && data.typing) {
            customerTyping.classList.remove('hidden');
            customerStatus.textContent = 'Typing...';
            chatContainer.scrollTop = chatContainer.scrollHeight;
        } else {
            customerTyping.classList.add('hidden');
            customerStatus.textContent = '{{ customer.email }}';
        }
        return;
    }
    
    if (data.type === 'message') {
        const msg = {
            id: data.message_id,
            message: data.message,
            image: data.image,
            is_from_admin: data.is_from_admin,
            created_at: data.created_at
        };
        renderMessage(msg);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
};

// Send typing indicator
adminInput.addEventListener('input', () => {
    clearTimeout(typingTimeout);
    ws.send(JSON.stringify({type: 'typing', typing: true, user_id: userId}));
    typingTimeout = setTimeout(() => {
        ws.send(JSON.stringify({type: 'typing', typing: false, user_id: userId}));
    }, 1000);
});

adminForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = adminInput.value.trim();
    const imageFile = adminImageInput.files[0];
    if (!msg && !imageFile) return;
    
    clearTimeout(typingTimeout);
    
    const formData = new FormData();
    if (msg) formData.append('message', msg);
    if (imageFile) formData.append('image', imageFile);
    formData.append('user_id', userId);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
        const response = await fetch('/api/send-admin-message/', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success) {
            console.log('‚úÖ Message saved to DB:', result.message);
            // Render immediately
            renderMessage(result.message);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            
            // Clear inputs
            adminInput.value = '';
            adminImageInput.value = '';
            adminImagePreview.classList.add('hidden');
        } else {
            console.error('‚ùå Failed to save message:', result);
        }
    } catch (error) {
        console.error('‚ùå Admin send error:', error);
    }
});

chatContainer.scrollTop = chatContainer.scrollHeight;
</script>
{% endblock %}
