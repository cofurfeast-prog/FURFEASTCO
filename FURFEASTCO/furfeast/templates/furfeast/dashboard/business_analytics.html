{% extends 'furfeast/dashboard/base.html' %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
            <h1 class="text-2xl md:text-3xl font-bold text-white">Business Analytics</h1>
            <p class="text-white mt-1">Track sales performance and customer insights</p>
        </div>
        <button onclick="openTargetModal()" class="bg-orange-600 text-white px-4 py-2 rounded-xl font-medium hover:bg-orange-700 transition-colors">
            Set Targets
        </button>
    </div>

    <!-- Sales Overview Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-600">This Week</p>
                    <p class="text-2xl font-bold text-slate-900">${{ week_sales|floatformat:0 }}</p>
                    {% if week_target %}
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-slate-500 mb-1">
                            <span>Target: ${{ week_target.target_amount|floatformat:0 }}</span>
                            <span>{{ week_progress|floatformat:0 }}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: {{ week_progress }}%"></div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button onclick="editTarget('week', {{ week_target.target_amount }})" class="text-xs text-blue-600 hover:text-blue-700">Edit</button>
                            <button onclick="showConfirm('Delete week target? This action cannot be undone.', () => window.location.href='{% url 'dashboard_delete_target' 'week' %}')" class="text-xs text-red-600 hover:text-red-700">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <button onclick="openTargetModal('week')" class="mt-2 text-xs text-blue-600 hover:text-blue-700">Set Target</button>
                    {% endif %}
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600">
                        <path d="M3 3v18h18"/>
                        <path d="m19 9-5 5-4-4-3 3"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-600">This Month</p>
                    <p class="text-2xl font-bold text-slate-900">${{ month_sales|floatformat:0 }}</p>
                    {% if month_target %}
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-slate-500 mb-1">
                            <span>Target: ${{ month_target.target_amount|floatformat:0 }}</span>
                            <span>{{ month_progress|floatformat:0 }}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="bg-green-600 h-2 rounded-full" style="width: {{ month_progress }}%"></div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button onclick="editTarget('month', {{ month_target.target_amount }})" class="text-xs text-green-600 hover:text-green-700">Edit</button>
                            <button onclick="showConfirm('Delete month target? This action cannot be undone.', () => window.location.href='{% url 'dashboard_delete_target' 'month' %}')" class="text-xs text-red-600 hover:text-red-700">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <button onclick="openTargetModal('month')" class="mt-2 text-xs text-green-600 hover:text-green-700">Set Target</button>
                    {% endif %}
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600">
                        <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                        <line x1="16" x2="16" y1="2" y2="6"/>
                        <line x1="8" x2="8" y1="2" y2="6"/>
                        <line x1="3" x2="21" y1="10" y2="10"/>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-slate-600">This Year</p>
                    <p class="text-2xl font-bold text-slate-900">${{ year_sales|floatformat:0 }}</p>
                    {% if year_target %}
                    <div class="mt-2">
                        <div class="flex justify-between text-xs text-slate-500 mb-1">
                            <span>Target: ${{ year_target.target_amount|floatformat:0 }}</span>
                            <span>{{ year_progress|floatformat:0 }}%</span>
                        </div>
                        <div class="w-full bg-slate-200 rounded-full h-2">
                            <div class="bg-orange-600 h-2 rounded-full" style="width: {{ year_progress }}%"></div>
                        </div>
                        <div class="mt-2 flex gap-2">
                            <button onclick="editTarget('year', {{ year_target.target_amount }})" class="text-xs text-orange-600 hover:text-orange-700">Edit</button>
                            <button onclick="showConfirm('Delete year target? This action cannot be undone.', () => window.location.href='{% url 'dashboard_delete_target' 'year' %}')" class="text-xs text-red-600 hover:text-red-700">Delete</button>
                        </div>
                    </div>
                    {% else %}
                    <button onclick="openTargetModal('year')" class="mt-2 text-xs text-orange-600 hover:text-orange-700">Set Target</button>
                    {% endif %}
                </div>
                <div class="w-12 h-12 bg-orange-100 rounded-xl flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-600">
                        <path d="M8 2v4"/>
                        <path d="M16 2v4"/>
                        <rect width="18" height="18" x="3" y="4" rx="2"/>
                        <path d="M3 10h18"/>
                        <path d="M8 14h.01"/>
                        <path d="M12 14h.01"/>
                        <path d="M16 14h.01"/>
                        <path d="M8 18h.01"/>
                        <path d="M12 18h.01"/>
                        <path d="M16 18h.01"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Sales Trend</h3>
                <select id="salesChartType" onchange="updateSalesChart()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                    <option value="line">Line Chart</option>
                    <option value="bar">Bar Chart</option>
                    <option value="area">Area Chart</option>
                </select>
            </div>
            <div class="relative h-64">
                <canvas id="salesChart" class="w-full h-full"></canvas>
            </div>
        </div>
        
        <div class="bg-white rounded-2xl p-4 md:p-6 shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-white">Target Progress</h3>
                <select id="targetChartType" onchange="updateTargetChart()" class="px-3 py-1 border border-slate-300 rounded-lg text-sm">
                    <option value="doughnut">Doughnut Chart</option>
                    <option value="pie">Pie Chart</option>
                    <option value="bar">Bar Chart</option>
                </select>
            </div>
            <div class="relative h-64">
                <canvas id="targetChart" class="w-full h-full"></canvas>
            </div>
        </div>
    </div>

    <!-- Customer Table -->
    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="p-4 md:p-6 border-b border-slate-200">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <h3 class="text-lg font-semibold text-white">Customer Data</h3>
                <div class="flex flex-col sm:flex-row gap-3">
                    <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="filterCustomers()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                    <select id="customerFilter" onchange="filterCustomers()" class="px-3 py-2 border border-slate-300 rounded-lg text-sm">
                        <option value="all">All Customers</option>
                        <option value="with_orders">With Orders Only</option>
                        <option value="no_orders">No Orders</option>
                        <option value="highest_spending">Highest Spending</option>
                        <option value="hide">Don't Show</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div class="overflow-x-auto" id="customerTable">
            <table class="w-full">
                <thead class="bg-slate-50">
                    <tr>
                        <th class="px-4 md:px-6 py-3 text-left">
                            <a href="?sort=name&order={% if sort_by == 'name' and order == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-2 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-700">
                                Name
                                {% if sort_by == 'name' %}
                                    {% if order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="px-4 md:px-6 py-3 text-left">
                            <a href="?sort=email&order={% if sort_by == 'email' and order == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-2 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-700">
                                Email
                                {% if sort_by == 'email' %}
                                    {% if order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="px-4 md:px-6 py-3 text-left">
                            <a href="?sort=orders&order={% if sort_by == 'orders' and order == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-2 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-700">
                                Orders
                                {% if sort_by == 'orders' %}
                                    {% if order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                        <th class="px-4 md:px-6 py-3 text-left">
                            <a href="?sort=spent&order={% if sort_by == 'spent' and order == 'asc' %}desc{% else %}asc{% endif %}" class="flex items-center gap-2 text-xs font-medium text-slate-500 uppercase tracking-wider hover:text-slate-700">
                                Total Spent
                                {% if sort_by == 'spent' %}
                                    {% if order == 'asc' %}‚Üë{% else %}‚Üì{% endif %}
                                {% endif %}
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                    {% for customer in customers %}
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-slate-900">{{ customer.first_name }} {{ customer.last_name }}</div>
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-500">{{ customer.email }}</div>
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-900">{{ customer.total_orders|default:0 }}</div>
                        </td>
                        <td class="px-4 md:px-6 py-4 whitespace-nowrap">
                            <div class="text-sm text-slate-900">${{ customer.total_spent|default:0|floatformat:2 }}</div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-center text-slate-500">No customers found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if customers.has_other_pages %}
        <div class="px-4 md:px-6 py-3 border-t border-slate-200 flex flex-col sm:flex-row sm:items-center justify-between gap-3">
            <div class="text-sm text-slate-700">
                Showing {{ customers.start_index }} to {{ customers.end_index }} of {{ customers.paginator.count }} results
            </div>
            <div class="flex gap-2">
                {% if customers.has_previous %}
                    <a href="?page={{ customers.previous_page_number }}&sort={{ sort_by }}&order={{ order }}" class="px-3 py-1 border border-slate-300 rounded text-sm hover:bg-slate-50">Previous</a>
                {% endif %}
                {% if customers.has_next %}
                    <a href="?page={{ customers.next_page_number }}&sort={{ sort_by }}&order={{ order }}" class="px-3 py-1 border border-slate-300 rounded text-sm hover:bg-slate-50">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Target Modal -->
<div id="targetModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-6 w-full max-w-md">
        <h3 class="text-lg font-semibold text-slate-900 mb-4">Set Business Target</h3>
        <form method="post" action="{% url 'dashboard_set_target' %}">
            {% csrf_token %}
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Period</label>
                    <select name="period" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">Target Amount ($)</label>
                    <input type="number" name="amount" step="0.01" required class="w-full px-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button type="button" onclick="closeTargetModal()" class="flex-1 px-4 py-2 border border-slate-300 rounded-xl text-slate-700 hover:bg-slate-50">Cancel</button>
                <button type="submit" class="flex-1 px-4 py-2 bg-orange-600 text-white rounded-xl hover:bg-orange-700">Set Target</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let salesChart, targetChart;

// Sales Chart
function createSalesChart(type = 'line') {
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    if (salesChart) salesChart.destroy();
    
    const config = {
        type: type,
        data: {
            labels: ['Week', 'Month', 'Year'],
            datasets: [{
                label: 'Sales ($)',
                data: [{{ week_sales }}, {{ month_sales }}, {{ year_sales }}],
                borderColor: '#f97316',
                backgroundColor: type === 'area' ? 'rgba(249, 115, 22, 0.3)' : 'rgba(249, 115, 22, 0.1)',
                tension: 0.4,
                fill: type === 'area'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    display: false,
                    labels: { color: 'white' }
                } 
            },
            scales: { 
                y: { 
                    beginAtZero: true,
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                },
                x: {
                    ticks: { color: 'white' },
                    grid: { color: 'rgba(255,255,255,0.1)' }
                }
            }
        }
    };
    
    if (type === 'area') config.type = 'line';
    salesChart = new Chart(salesCtx, config);
}

// Target Chart
function createTargetChart(type = 'doughnut') {
    const targetCtx = document.getElementById('targetChart').getContext('2d');
    if (targetChart) targetChart.destroy();
    
    targetChart = new Chart(targetCtx, {
        type: type,
        data: {
            labels: ['Week Progress', 'Month Progress', 'Year Progress'],
            datasets: [{
                data: [{{ week_progress|floatformat:1 }}, {{ month_progress|floatformat:1 }}, {{ year_progress|floatformat:1 }}],
                backgroundColor: ['#3b82f6', '#10b981', '#f97316']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { 
                    position: 'bottom',
                    labels: { color: 'white' }
                } 
            }
        }
    });
}

function updateSalesChart() {
    const type = document.getElementById('salesChartType').value;
    createSalesChart(type);
}

function updateTargetChart() {
    const type = document.getElementById('targetChartType').value;
    createTargetChart(type);
}

// Initialize charts
createSalesChart();
createTargetChart();

// Target Modal Functions
function openTargetModal(period = '') {
    document.getElementById('targetModal').classList.remove('hidden');
    if (period) {
        document.querySelector('select[name="period"]').value = period;
    }
}

function editTarget(period, currentAmount) {
    document.getElementById('targetModal').classList.remove('hidden');
    document.querySelector('select[name="period"]').value = period;
    document.querySelector('input[name="amount"]').value = currentAmount;
}

function closeTargetModal() {
    document.getElementById('targetModal').classList.add('hidden');
    document.querySelector('input[name="amount"]').value = '';
}

// FurFeast Custom Confirm Modal
function showConfirm(message, onConfirm) {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    
    overlay.innerHTML = `
        <div class="bg-white rounded-2xl p-6 w-full max-w-md transform scale-90 transition-transform duration-300">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 12px;">üêæ</div>
                <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 8px;">FurFeast</h3>
                <p style="color: #64748b; font-size: 14px;">${message}</p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button onclick="closeConfirmModal()" style="padding: 10px 20px; background: #e2e8f0; color: #475569; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">Cancel</button>
                <button onclick="confirmAction()" style="padding: 10px 20px; background: #f97316; color: white; border: none; border-radius: 8px; font-weight: 500; cursor: pointer;">Confirm</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    window.closeConfirmModal = () => {
        overlay.classList.add('opacity-0');
        setTimeout(() => document.body.removeChild(overlay), 300);
    };
    
    window.confirmAction = () => {
        onConfirm();
        closeConfirmModal();
    };
    
    setTimeout(() => {
        overlay.querySelector('.bg-white').classList.remove('scale-90');
        overlay.querySelector('.bg-white').classList.add('scale-100');
    }, 100);
}

// Customer Filtering
function filterCustomers() {
    const search = document.getElementById('customerSearch').value.toLowerCase();
    const filter = document.getElementById('customerFilter').value;
    const rows = document.querySelectorAll('tbody tr');
    const tableContainer = document.getElementById('customerTable');
    
    // Handle hide option
    if (filter === 'hide') {
        tableContainer.style.display = 'none';
        return;
    } else {
        tableContainer.style.display = 'block';
    }
    
    let visibleRows = [];
    
    rows.forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const email = row.cells[1].textContent.toLowerCase();
        const orders = parseInt(row.cells[2].textContent) || 0;
        const spent = parseFloat(row.cells[3].textContent.replace('$', '')) || 0;
        
        let showRow = true;
        
        // Search filter
        if (search && !name.includes(search) && !email.includes(search)) {
            showRow = false;
        }
        
        // Category filter
        if (filter === 'with_orders' && orders === 0) {
            showRow = false;
        } else if (filter === 'no_orders' && orders > 0) {
            showRow = false;
        }
        
        if (showRow) {
            visibleRows.push({row, spent});
        }
        
        row.style.display = 'none';
    });
    
    // Handle highest spending filter
    if (filter === 'highest_spending') {
        visibleRows.sort((a, b) => b.spent - a.spent);
        visibleRows = visibleRows.slice(0, 10); // Show top 10
    }
    
    visibleRows.forEach(({row}) => {
        row.style.display = '';
    });
}
</script>
{% endblock %}