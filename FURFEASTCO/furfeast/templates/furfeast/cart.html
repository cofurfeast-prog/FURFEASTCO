{% extends 'furfeast/base.html' %}

{% block content %}
<main class="pt-24 pb-32 px-4 sm:px-6 lg:px-12 bg-background min-h-screen">
    <div class="max-w-4xl mx-auto">
        <div class="mb-8 md:mb-12">
            <h1 class="text-2xl md:text-4xl font-bold text-foreground mb-2 font-heading">Your Shopping Cart</h1>
            <p class="text-muted-foreground text-sm md:text-base">Review your items before checkout</p>
        </div>

        {% if cart.items.all %}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-12">
            <!-- Items List -->
            <div class="lg:col-span-2 space-y-4">
                {% for item in cart.items.all %}
                <div class="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm" data-item-id="{{ item.id }}">
                    <div class="flex gap-4">
                        <!-- Product Image -->
                        <div class="flex-shrink-0">
                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}"
                                class="w-20 h-20 object-cover rounded-lg">
                        </div>
                        
                        <!-- Product Details -->
                        <div class="flex-1 min-w-0">
                            <div class="flex flex-col h-full">
                                <!-- Product Name & Category -->
                                <div class="mb-2">
                                    <h3 class="font-bold text-slate-900 text-base leading-tight">{{ item.product.name }}</h3>
                                    <p class="text-slate-500 text-sm">{{ item.product.category|title }}</p>
                                </div>
                                
                                <!-- Price & Controls -->
                                <div class="flex items-center justify-between mt-auto">
                                    <span class="text-primary font-bold text-lg">${{ item.product.price }}</span>
                                    
                                    <div class="flex items-center gap-3">
                                        <!-- Quantity Controls -->
                                        <div class="flex items-center gap-1 bg-slate-50 p-1 rounded-lg border">
                                            <button onclick="updateCartItem({{ item.id }}, 'decrease')" 
                                                class="w-8 h-8 rounded bg-white flex items-center justify-center border text-sm text-green-600 hover:bg-red-50 transition-colors">
                                                -
                                            </button>
                                            <span class="font-bold px-3 min-w-[2rem] text-center text-sm text-green-600" id="qty-{{ item.id }}">{{ item.quantity }}</span>
                                            <button onclick="updateCartItem({{ item.id }}, 'increase')" 
                                                class="w-8 h-8 rounded bg-white flex items-center justify-center border text-sm text-green-600 hover:bg-green-50 transition-colors">
                                                +
                                            </button>
                                        </div>
                                        
                                        <!-- Remove Button -->
                                        <button onclick="updateCartItem({{ item.id }}, 'remove')" 
                                            class="text-red-500 hover:text-red-700 text-sm font-semibold px-2 py-1 rounded border border-red-200 hover:bg-red-50 transition-colors">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 md:p-8 rounded-2xl md:rounded-3xl border border-slate-100 shadow-sm lg:sticky lg:top-24">
                    <h2 class="text-lg md:text-xl font-bold text-green-600 mb-6">Order Summary</h2>
                    <div class="space-y-4 mb-8">
                        <div class="flex justify-between text-slate-600">
                            <span>Subtotal</span>
                            <span class="font-bold" id="cart-subtotal">${{ cart.total_price }}</span>
                        </div>
                        <div class="flex justify-between text-slate-600">
                            <span>Shipping</span>
                            <span class="text-green-600 font-bold">Free</span>
                        </div>
                        <div class="pt-4 border-t border-slate-100 flex justify-between text-slate-900">
                            <span class="font-bold text-lg">Total</span>
                            <span class="font-bold text-lg text-primary" id="cart-total">${{ cart.total_price }}</span>
                        </div>
                    </div>
                    
                    <!-- Delivery Address Form -->
                    <div class="mb-6 p-4 bg-slate-50 rounded-lg">
                        <h3 class="font-semibold text-green-600 mb-3">Delivery Address</h3>
                        <div class="space-y-3">
                            <input type="text" id="shipping-address" placeholder="Full Address" 
                                   value="{{ user.profile.address|default:'' }}" required
                                   class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent text-green-600">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="text" id="shipping-phone" placeholder="+1 202-555-0147" 
                                       value="{{ user.profile.phone_number|default:'' }}" required
                                       class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent text-green-600">
                                <input type="text" id="shipping-city" placeholder="City" 
                                       value="{{ user.profile.city|default:'' }}" required
                                       class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent text-green-600">
                            </div>
                            <input type="text" id="shipping-postal" placeholder="Postal Code" 
                                   value="{{ user.profile.postal_code|default:'' }}"
                                   class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-primary focus:border-transparent text-green-600">
                        </div>
                    </div>
                    
                    <button onclick="clearCart()" class="w-full py-3 mb-4 border border-red-200 text-red-600 font-semibent rounded-xl hover:bg-red-50 transition-colors text-sm bg-white">
                        üóëÔ∏è Clear Cart
                    </button>
                    
                    {% if cart.items.all %}
                    <!-- Payment Method Selection -->
                    <div class="mb-4">
                        <h3 class="font-semibold text-green-600 mb-3">Payment Method</h3>
                        <div class="space-y-2">
                            <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                <input type="radio" name="payment-method" value="paypal" checked class="mr-3">
                                <span class="font-medium text-green-600">PayPal</span>
                            </label>
                            <label class="flex items-center p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50">
                                <input type="radio" name="payment-method" value="cod" class="mr-3">
                                <span class="font-medium text-green-600">Cash on Delivery (COD)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="paypal-button-container" class="mb-4"></div>
                    <button id="checkout-btn" onclick="initiateCheckout()"
                        class="w-full py-3 md:py-4 bg-background text-foreground font-bold rounded-xl md:rounded-2xl hover:bg-green-700 transition-all shadow-lg shadow-background/10 text-sm md:text-base">
                        Proceed to Checkout
                    </button>
                    {% else %}
                    <button disabled
                        class="w-full py-3 md:py-4 bg-gray-300 text-gray-500 font-bold rounded-xl md:rounded-2xl cursor-not-allowed text-sm md:text-base">
                        Cart is Empty
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="bg-white p-8 md:p-20 rounded-2xl md:rounded-3xl border border-slate-100 shadow-sm text-center">
            <div class="text-4xl md:text-6xl mb-6">üõí</div>
            <h2 class="text-xl md:text-2xl font-bold text-foreground mb-2">Your cart is empty</h2>
            <p class="text-muted-foreground mb-8 text-sm md:text-base">Looks like you haven't added anything to your cart yet.</p>
            <a href="{% url 'shop' %}"
                class="inline-block px-6 md:px-8 py-3 md:py-4 bg-background text-foreground font-bold rounded-xl md:rounded-2xl hover:bg-green-700 transition-all text-sm md:text-base">
                Browse Products
            </a>
        </div>
        {% endif %}
    </div>
</main>

<!-- Ensure CSRF token is available -->
{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">

<script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD&intent=capture&enable-funding=venmo&disable-funding=credit,card"></script>
<script>
// PayPal checkout function
function initiateCheckout() {
    // Validate address fields
    const address = document.getElementById('shipping-address').value.trim();
    const phone = document.getElementById('shipping-phone').value.trim();
    const city = document.getElementById('shipping-city').value.trim();
    
    if (!address || !phone || !city) {
        alert('Please fill in all required delivery address fields.');
        return;
    }
    
    const paymentMethod = document.querySelector('input[name="payment-method"]:checked').value;
    
    if (paymentMethod === 'cod') {
        processCODOrder();
    } else {
        processPayPalOrder();
    }
}

function processCODOrder() {
    const address = document.getElementById('shipping-address').value.trim();
    const phone = document.getElementById('shipping-phone').value.trim();
    const city = document.getElementById('shipping-city').value.trim();
    const postal = document.getElementById('shipping-postal').value.trim();
    
    fetch('/api/cod/order/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            shipping_address: address,
            shipping_phone: phone,
            shipping_city: city,
            shipping_postal_code: postal
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '/order-success/';
        } else {
            alert('Order processing failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

function processPayPalOrder() {
    // Check if PayPal SDK is loaded
    if (typeof paypal === 'undefined') {
        alert('PayPal is not available. Please refresh the page and try again.');
        return;
    }
    
    document.getElementById('checkout-btn').style.display = 'none';
    document.getElementById('paypal-button-container').innerHTML = '';
    
    paypal.Buttons({
        style: {
            layout: 'vertical',
            color: 'gold',
            shape: 'rect',
            label: 'paypal'
        },
        createOrder: function(data, actions) {
            const totalAmount = parseFloat('{{ cart.total_price }}').toFixed(2);
            console.log('Creating PayPal order with amount:', totalAmount);
            
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: totalAmount,
                        currency_code: 'USD'
                    },
                    description: 'FurFeast Pet Products Order',
                    custom_id: 'FF_{{ user.id }}_' + Date.now()
                }],
                application_context: {
                    shipping_preference: 'NO_SHIPPING',
                    user_action: 'PAY_NOW'
                }
            }).catch(function(err) {
                console.error('PayPal createOrder error:', err);
                alert('Failed to create PayPal order. Please try again.');
                document.getElementById('checkout-btn').style.display = 'block';
                throw err;
            });
        },
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                const address = document.getElementById('shipping-address').value.trim();
                const phone = document.getElementById('shipping-phone').value.trim();
                const city = document.getElementById('shipping-city').value.trim();
                const postal = document.getElementById('shipping-postal').value.trim();
                
                fetch('/api/paypal/capture/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        orderID: data.orderID,
                        paymentID: details.id,
                        shipping_address: address,
                        shipping_phone: phone,
                        shipping_city: city,
                        shipping_postal_code: postal
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = '/order-success/';
                    } else {
                        alert('Payment processing failed');
                        document.getElementById('checkout-btn').style.display = 'block';
                    }
                });
            });
        },
        onError: function(err) {
            console.error('PayPal Error:', err);
            alert('PayPal encountered an error. Please try again.');
            document.getElementById('checkout-btn').style.display = 'block';
        },
        onCancel: function(data) {
            console.log('PayPal payment cancelled');
            document.getElementById('checkout-btn').style.display = 'block';
        }
    }).render('#paypal-button-container').catch(function(err) {
        console.error('PayPal render error:', err);
        alert('Unable to load PayPal. Please refresh and try again.');
        document.getElementById('checkout-btn').style.display = 'block';
    });
}

// Cart functions - simplified and reliable
function updateCartItem(itemId, action) {
    console.log('Updating cart item:', itemId, action);
    
    if (action === 'remove') {
        showFurFeastConfirm('Remove this item from your cart? üêæ', function() {
            performCartUpdate(itemId, action);
        });
        return;
    }
    
    performCartUpdate(itemId, action);
}

function performCartUpdate(itemId, action) {
    // Disable checkout button immediately to prevent exploitation
    const checkoutBtn = document.getElementById('checkout-btn');
    const paypalContainer = document.getElementById('paypal-button-container');
    if (checkoutBtn) {
        checkoutBtn.disabled = true;
        checkoutBtn.textContent = 'Updating...';
    }
    if (paypalContainer) {
        paypalContainer.style.display = 'none';
    }
    
    // Immediate UI update for fast response
    const qtyElement = document.getElementById(`qty-${itemId}`);
    const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
    
    if (qtyElement && action !== 'remove') {
        let currentQty = parseInt(qtyElement.textContent);
        if (action === 'increase') {
            qtyElement.textContent = currentQty + 1;
        } else if (action === 'decrease' && currentQty > 1) {
            qtyElement.textContent = currentQty - 1;
        }
        // Don't change UI if quantity is already 1
    } else if (action === 'remove') {
        itemElement?.remove();
    }
    
    let csrfToken = getCookie('csrftoken');
    
    if (!csrfToken) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
    }
    
    if (!csrfToken) {
        const csrfMeta = document.querySelector('meta[name=csrf-token]');
        if (csrfMeta) {
            csrfToken = csrfMeta.getAttribute('content');
        }
    }
    
    if (!csrfToken) {
        alert('Security token not found. Please refresh the page.');
        return;
    }
    
    const formData = new URLSearchParams();
    formData.append('action', action);
    
    fetch('/api/cart/update/' + itemId + '/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData.toString(),
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Update badges with server response
            updateCartBadge(data.cart_count);
            if (data.wishlist_count !== undefined) {
                updateWishlistBadge(data.wishlist_count);
            }
            // Update totals immediately
            const subtotalEl = document.getElementById('cart-subtotal');
            const totalEl = document.getElementById('cart-total');
            if (subtotalEl) subtotalEl.textContent = '$' + data.total_price;
            if (totalEl) totalEl.textContent = '$' + data.total_price;
            
            // Re-enable checkout button
            if (checkoutBtn) {
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'Checkout with PayPal';
            }
            if (paypalContainer) {
                paypalContainer.style.display = 'block';
            }
        } else {
            // Revert UI changes on error
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        // Revert UI changes on error
        window.location.reload();
    });
}

function clearCart() {
    showFurFeastConfirm('Are you sure you want to clear your entire cart? This action cannot be undone! üêæ', function() {
        performClearCart();
    });
}

function performClearCart() {
    let csrfToken = getCookie('csrftoken');
    if (!csrfToken) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            csrfToken = csrfInput.value;
        }
    }
    
    if (!csrfToken) {
        alert('Security token not found. Please refresh the page.');
        return;
    }
    
    fetch('/api/cart/clear/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error clearing cart: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error. Please try again.');
    });
}

// FurFeast Custom Confirm Modal
function showFurFeastConfirm(message, onConfirm) {
    const existingModal = document.querySelector('.furfeast-modal-overlay');
    if (existingModal) {
        existingModal.remove();
    }
    
    const overlay = document.createElement('div');
    overlay.className = 'furfeast-modal-overlay';
    overlay.style.cssText = `
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    `;
    
    overlay.innerHTML = `
        <div class="furfeast-modal" style="
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            transform: scale(0.9);
            transition: transform 0.3s ease;
            text-align: center;
        ">
            <div style="margin-bottom: 20px;">
                <div style="font-size: 48px; margin-bottom: 12px;">üêæ</div>
                <h3 style="font-size: 18px; font-weight: 600; color: #1e293b; margin: 0 0 8px 0; font-family: 'Nunito', sans-serif;">FurFeast</h3>
                <p style="color: #64748b; font-size: 14px; margin: 0; line-height: 1.5;">${message}</p>
            </div>
            <div style="display: flex; gap: 12px; justify-content: center;">
                <button class="cancel-btn" style="
                    padding: 10px 20px;
                    background: #e2e8f0;
                    color: #475569;
                    border: none;
                    border-radius: 8px;
                    font-weight: 500;
                    cursor: pointer;
                    font-family: inherit;
                    transition: background-color 0.2s;
                ">Cancel</button>
                <button class="confirm-btn" style="
                    padding: 10px 20px;
                    background: #f97316;
                    color: white;
                    border: none;
                    border-radius: 8px;
                    font-weight: 500;
                    cursor: pointer;
                    font-family: inherit;
                    transition: background-color 0.2s;
                ">Confirm</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    const cancelBtn = overlay.querySelector('.cancel-btn');
    const confirmBtn = overlay.querySelector('.confirm-btn');
    
    const closeModal = () => {
        overlay.style.opacity = '0';
        overlay.style.visibility = 'hidden';
        setTimeout(() => {
            if (overlay.parentNode) {
                document.body.removeChild(overlay);
            }
        }, 300);
    };
    
    cancelBtn.addEventListener('click', closeModal);
    confirmBtn.addEventListener('click', () => {
        onConfirm();
        closeModal();
    });
    
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
            closeModal();
        }
    });
    
    setTimeout(() => {
        overlay.style.opacity = '1';
        overlay.style.visibility = 'visible';
        const modal = overlay.querySelector('.furfeast-modal');
        if (modal) {
            modal.style.transform = 'scale(1)';
        }
    }, 10);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateCartBadge(count) {
    const badge = document.getElementById('cart-badge');
    if (badge) {
        badge.textContent = count;
        if (count > 0) {
            badge.classList.remove('opacity-0');
            badge.classList.add('opacity-100');
        } else {
            badge.classList.add('opacity-0');
            badge.classList.remove('opacity-100');
        }
    }
}

function updateWishlistBadge(count) {
    const badge = document.getElementById('wishlist-badge');
    if (badge) {
        badge.textContent = count;
        if (count > 0) {
            badge.classList.remove('opacity-0');
            badge.classList.add('opacity-100');
        } else {
            badge.classList.add('opacity-0');
            badge.classList.remove('opacity-100');
        }
    }
}
</script>
{% endblock %}