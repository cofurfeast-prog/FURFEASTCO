{% extends 'furfeast/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - FURFEAST CO.{% endblock %}

{% block content %}
<main class="pt-24 pb-16">
    <!-- Product Detail Section -->
    <section class="py-8 md:py-12">
        <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-12">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-16">
                <!-- Product Image -->
                <div class="space-y-4">
                    <div class="aspect-square bg-slate-100 rounded-3xl overflow-hidden max-w-lg mx-auto lg:max-w-none">
                        {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <div class="w-full h-full flex items-center justify-center text-slate-400">
                            No Image Available
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Product Info -->
                <div class="space-y-6 lg:py-8 max-w-md">
                    <div>
                        <div class="text-sm text-primary font-bold uppercase tracking-wide mb-2">
                            {{ product.get_category_display }}
                        </div>
                        <h1 class="text-2xl md:text-3xl lg:text-4xl font-extrabold text-slate-900 mb-4 leading-tight">
                            {{ product.name }}
                        </h1>

                        <!-- Rating -->
                        <div class="flex items-center gap-2 mb-6">
                            <div class="flex text-amber-400">
                                {% for i in "12345" %}
                                {% if forloop.counter <= avg_rating %} <span class="text-lg">‚òÖ</span>
                                    {% else %}
                                    <span class="text-lg text-slate-300">‚òÖ</span>
                                    {% endif %}
                                    {% endfor %}
                            </div>
                            <span class="text-slate-600 font-medium text-sm">
                                ({{ avg_rating|floatformat:1 }}) ‚Ä¢ {{ review_count }} review{{ review_count|pluralize }}
                            </span>
                        </div>

                        <!-- Price -->
                        <div class="flex flex-wrap items-center gap-3 mb-6">
                            <div class="text-3xl lg:text-4xl font-extrabold text-primary">${{ product.price }}</div>
                            {% if product.original_price %}
                            <div class="text-lg lg:text-xl text-slate-400 line-through">${{ product.original_price }}
                            </div>
                            <div class="bg-red-100 text-red-700 px-3 py-1 rounded-full text-xs font-bold">
                                SALE
                            </div>
                            {% endif %}
                        </div>

                        <!-- Stock Status -->
                        {% if product.is_out_of_stock or product.stock == 0 %}
                        <div class="bg-red-50 border border-red-200 rounded-xl px-4 py-3 mb-6">
                            <div class="flex items-center gap-2 text-red-700">
                                <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-bold text-sm">Out of Stock</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="bg-green-50 border border-green-200 rounded-xl px-4 py-3 mb-6">
                            <div class="flex items-center gap-2 text-green-700">
                                <svg class="w-5 h-5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd"
                                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                        clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-bold text-sm">In Stock ({{ product.stock }} available)</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Action Buttons -->
                    <div class="space-y-4">
                        {% if not product.is_out_of_stock and product.stock > 0 %}
                        <!-- Buy Now Button -->
                        <a href="{% url 'buy_now' product.id %}"
                            class="w-full bg-primary text-white font-bold py-4 px-8 rounded-xl text-center block hover:bg-orange-600 transition-all shadow-lg text-lg">
                            Buy Now
                        </a>

                        <!-- Add to Cart & Wishlist -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button onclick="addToCart('{{ product.id }}')"
                                class="w-full bg-slate-900 text-white font-semibold py-4 px-6 rounded-xl hover:bg-slate-800 transition-all flex items-center justify-center gap-2 text-base">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M3 3h2l.4 2M7 13h10l4-8H5.4m0 0L7 13m0 0l-1.5 6M7 13l-1.5 6m0 0h9m-9 0V19a2 2 0 002 2h9a2 2 0 002-2v-4">
                                    </path>
                                </svg>
                                <span>Add to Cart</span>
                            </button>
                            <button onclick="addToWishlist('{{ product.id }}')"
                                class="w-full border-2 border-slate-300 text-slate-700 font-semibold py-4 px-6 rounded-xl hover:border-primary hover:text-primary transition-all flex items-center justify-center gap-2 text-base">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z">
                                    </path>
                                </svg>
                                <span>Wishlist</span>
                            </button>
                        </div>
                        {% else %}
                        <button disabled
                            class="w-full bg-gray-400 text-white font-bold py-4 px-6 rounded-xl text-center cursor-not-allowed">
                            Out of Stock
                        </button>
                        {% endif %}
                    </div>

                    <!-- Product Description -->
                    <div class="border-t pt-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-3">Product Description</h3>
                        <p class="text-slate-600 leading-relaxed text-sm lg:text-base">{{ product.description }}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Reviews Section -->
    <section class="py-6 lg:py-12 bg-slate-50">
        <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-12">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-12">
                <!-- Reviews List -->
                <div class="lg:col-span-2">
                    <h3 class="text-lg sm:text-xl lg:text-2xl font-bold text-slate-900 mb-4 lg:mb-6">Customer Reviews ({{ review_count }})</h3>
                    
                    {% if reviews %}
                    <div class="space-y-3 lg:space-y-4">
                        {% for review in reviews %}
                        <div class="bg-white rounded-xl p-3 sm:p-4 lg:p-6 shadow-sm">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex items-center gap-2 sm:gap-3">
                                    {% if review.user.profile.profile_picture %}
                                    <img src="{{ review.user.profile.profile_picture.url }}" alt="{{ review.user.first_name }}" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full object-cover">
                                    {% else %}
                                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold text-xs sm:text-sm">
                                        {{ review.user.first_name|first|upper }}
                                    </div>
                                    {% endif %}
                                    <div>
                                        <h4 class="font-bold text-slate-900 text-sm lg:text-base">{{ review.user.first_name }} {{ review.user.last_name }}</h4>
                                        <div class="flex text-amber-400 text-xs sm:text-sm">
                                            {% for i in "12345" %}
                                                {% if forloop.counter <= review.rating %}
                                                    <span>‚òÖ</span>
                                                {% else %}
                                                    <span class="text-slate-300">‚òÖ</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="text-slate-500 text-xs lg:text-sm">{{ review.created_at|date:"M d, Y" }}</span>
                                    {% if review.user == user %}
                                    <button onclick="editReview({{ review.id }}, {{ review.rating }}, '{{ review.comment|escapejs }}')"
                                        class="text-blue-600 hover:text-blue-800 text-xs font-medium">
                                        Edit
                                    </button>
                                    <button onclick="deleteReview({{ review.id }})"
                                        class="text-red-600 hover:text-red-800 text-xs font-medium">
                                        Delete
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            <p class="text-slate-700 leading-relaxed text-sm lg:text-base">{{ review.comment }}</p>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8 lg:py-12">
                        <div class="text-slate-400 text-4xl lg:text-6xl mb-4">üí¨</div>
                        <h4 class="text-lg lg:text-xl font-bold text-slate-600 mb-2">No reviews yet</h4>
                        <p class="text-slate-500 text-sm lg:text-base">Be the first to review this product!</p>
                    </div>
                    {% endif %}
                </div>

                <!-- Add Review Form -->
                <div>
                    {% if user.is_authenticated %}
                    <div class="bg-white rounded-xl p-4 lg:p-6 shadow-sm lg:sticky lg:top-24">
                        <h3 class="text-lg lg:text-xl font-bold text-slate-900 mb-4 lg:mb-6">Write a Review</h3>
                        <form id="reviewForm" class="space-y-4">
                            {% csrf_token %}
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Rating</label>
                                <div class="flex gap-1" id="starRating">
                                    {% for i in "12345" %}
                                    <button type="button" class="star text-xl lg:text-2xl text-slate-300 hover:text-amber-400 transition-colors" data-rating="{{ forloop.counter }}">‚òÖ</button>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="rating" name="rating" required>
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-slate-700 mb-2">Your Review</label>
                                <textarea name="comment" rows="4" required class="w-full border border-slate-300 rounded-xl px-3 py-2 lg:px-4 lg:py-3 focus:border-primary focus:outline-none text-sm lg:text-base" placeholder="Share your experience with this product..."></textarea>
                            </div>
                            <button type="submit" class="w-full bg-primary text-white font-bold py-2 lg:py-3 rounded-xl hover:bg-orange-600 transition-all text-sm lg:text-base">
                                Submit Review
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="bg-white rounded-xl p-4 lg:p-6 shadow-sm text-center">
                        <h3 class="text-lg lg:text-xl font-bold text-slate-900 mb-4">Want to leave a review?</h3>
                        <p class="text-slate-600 mb-6 text-sm lg:text-base">Please log in to share your experience with this product.</p>
                        <a href="{% url 'login' %}" class="bg-primary text-white font-bold py-2 lg:py-3 px-4 lg:px-6 rounded-xl hover:bg-orange-600 transition-all text-sm lg:text-base">
                            Log In
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </section>

    <!-- Related Products -->
    {% if related_products %}
    <section class="py-12 lg:py-16 bg-white">
        <div class="max-w-[1440px] mx-auto px-4 sm:px-6 lg:px-12">
            <h3 class="text-2xl lg:text-3xl font-bold text-slate-900 mb-6 lg:mb-8">Related Products</h3>
            <div class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
                {% for product in related_products %}
                <div
                    class="group bg-white rounded-2xl lg:rounded-3xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300">
                    <div class="relative aspect-square overflow-hidden bg-slate-100">
                        <a href="{% url 'product_detail' product.id %}">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                                class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                            {% else %}
                            <div
                                class="w-full h-full flex items-center justify-center text-slate-400 text-xs lg:text-sm">
                                No Image</div>
                            {% endif %}
                        </a>
                    </div>
                    <div class="p-3 lg:p-4">
                        <a href="{% url 'product_detail' product.id %}">
                            <h4 class="font-bold text-slate-800 mb-2 text-sm lg:text-base line-clamp-2">{{ product.name }}</h4>
                        </a>
                        <div class="text-lg lg:text-xl font-bold text-primary">${{ product.price }}</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
</main>

<script>
    // Star rating functionality
    document.addEventListener('DOMContentLoaded', function () {
        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('rating');
        let selectedRating = 0;

        stars.forEach((star, index) => {
            star.addEventListener('click', function () {
                selectedRating = index + 1;
                ratingInput.value = selectedRating;
                updateStars();
            });

            star.addEventListener('mouseover', function () {
                highlightStars(index + 1);
            });
        });

        document.getElementById('starRating').addEventListener('mouseleave', function () {
            updateStars();
        });

        function highlightStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('text-amber-400');
                    star.classList.remove('text-slate-300');
                } else {
                    star.classList.add('text-slate-300');
                    star.classList.remove('text-amber-400');
                }
            });
        }

        function updateStars() {
            highlightStars(selectedRating);
        }

        // Review form submission
        document.getElementById('reviewForm').addEventListener('submit', function (e) {
            e.preventDefault();

            if (!selectedRating) {
                alert('Please select a rating');
                return;
            }

            const submitButton = this.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Submitting...';
            submitButton.disabled = true;

            const formData = new FormData(this);

            fetch('{% url "add_review" product.id %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showFurFeastModal('üéâ Review Submitted!', 'Thank you for your review! Your feedback helps other pet parents make better choices.');
                        setTimeout(() => location.reload(), 2000);
                    } else {
                        alert(data.error || 'Failed to add review');
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                    submitButton.textContent = originalText;
                    submitButton.disabled = false;
                });
        });
    });

    // Edit review function
    function editReview(reviewId, currentRating, currentComment) {
        showFurFeastEditModal(reviewId, currentRating, currentComment);
    }

    // Delete review function
    function deleteReview(reviewId) {
        showFurFeastDeleteModal(reviewId);
    }
</script>

<!-- FurFeast Modal Script -->
<script>
// FurFeast Modal Function
function showFurFeastModal(title, message) {
    // Remove existing modal if any
    const existingModal = document.getElementById('furFeastModal');
    if (existingModal) existingModal.remove();
    
    // Create modal
    const modal = document.createElement('div');
    modal.id = 'furFeastModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 text-center transform scale-95 transition-transform duration-300">
            <div class="text-6xl mb-4">üê∂</div>
            <h3 class="text-2xl font-bold text-slate-900 mb-4">${title}</h3>
            <p class="text-slate-600 mb-6">${message}</p>
            <button onclick="closeFurFeastModal()" class="bg-primary text-white font-bold py-3 px-8 rounded-xl hover:bg-orange-600 transition-all">
                Awesome!
            </button>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Animate in
    setTimeout(() => {
        modal.querySelector('div').classList.remove('scale-95');
        modal.querySelector('div').classList.add('scale-100');
    }, 10);
}

function closeFurFeastModal() {
    const modal = document.getElementById('furFeastModal');
    if (modal) modal.remove();
}

// FurFeast Edit Review Modal
function showFurFeastEditModal(reviewId, currentRating, currentComment) {
    const existingModal = document.getElementById('furFeastModal');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'furFeastModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 text-center transform scale-95 transition-transform duration-300">
            <div class="text-6xl mb-4">üêæ</div>
            <h3 class="text-2xl font-bold text-slate-900 mb-4">Edit Your Review</h3>
            <div class="text-left space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Rating</label>
                    <div class="flex gap-1 justify-center" id="editStarRating">
                        <button type="button" class="edit-star text-2xl text-slate-300 hover:text-amber-400" data-rating="1">‚òÖ</button>
                        <button type="button" class="edit-star text-2xl text-slate-300 hover:text-amber-400" data-rating="2">‚òÖ</button>
                        <button type="button" class="edit-star text-2xl text-slate-300 hover:text-amber-400" data-rating="3">‚òÖ</button>
                        <button type="button" class="edit-star text-2xl text-slate-300 hover:text-amber-400" data-rating="4">‚òÖ</button>
                        <button type="button" class="edit-star text-2xl text-slate-300 hover:text-amber-400" data-rating="5">‚òÖ</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">Comment</label>
                    <textarea id="editComment" class="w-full border border-slate-300 rounded-xl px-3 py-2 focus:border-primary focus:outline-none" rows="3">${currentComment}</textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-6">
                <button onclick="closeFurFeastModal()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-xl hover:bg-slate-300 transition-all">
                    Cancel
                </button>
                <button onclick="submitEditReview(${reviewId})" class="flex-1 bg-primary text-white font-bold py-3 px-4 rounded-xl hover:bg-orange-600 transition-all">
                    Update
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Set current rating
    let editRating = currentRating;
    const editStars = modal.querySelectorAll('.edit-star');
    
    function updateEditStars() {
        editStars.forEach((star, index) => {
            if (index < editRating) {
                star.classList.add('text-amber-400');
                star.classList.remove('text-slate-300');
            } else {
                star.classList.add('text-slate-300');
                star.classList.remove('text-amber-400');
            }
        });
    }
    
    editStars.forEach((star, index) => {
        star.addEventListener('click', () => {
            editRating = index + 1;
            updateEditStars();
        });
    });
    
    updateEditStars();
    
    // Animate in
    setTimeout(() => {
        modal.querySelector('div').classList.remove('scale-95');
        modal.querySelector('div').classList.add('scale-100');
    }, 10);
    
    window.currentEditRating = editRating;
}

// Submit edit review
function submitEditReview(reviewId) {
    const newComment = document.getElementById('editComment').value.trim();
    const newRating = window.currentEditRating;
    
    if (!newComment || !newRating) {
        alert('Please provide both rating and comment');
        return;
    }
    
    const formData = new FormData();
    formData.append('rating', newRating);
    formData.append('comment', newComment);
    
    fetch(`/review/${reviewId}/edit/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFurFeastModal('‚úÖ Review Updated!', 'Your review has been updated successfully!');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert(data.error || 'Failed to update review');
        }
    })
    .catch(error => {
        alert('An error occurred. Please try again.');
    });
}

// FurFeast Delete Review Modal
function showFurFeastDeleteModal(reviewId) {
    const existingModal = document.getElementById('furFeastModal');
    if (existingModal) existingModal.remove();
    
    const modal = document.createElement('div');
    modal.id = 'furFeastModal';
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    modal.innerHTML = `
        <div class="bg-white rounded-3xl p-8 max-w-md mx-4 text-center transform scale-95 transition-transform duration-300">
            <div class="text-6xl mb-4">üòø</div>
            <h3 class="text-2xl font-bold text-slate-900 mb-4">Delete Review?</h3>
            <p class="text-slate-600 mb-6">Are you sure you want to delete your review? This action cannot be undone.</p>
            <div class="flex gap-3">
                <button onclick="closeFurFeastModal()" class="flex-1 bg-slate-200 text-slate-700 font-bold py-3 px-4 rounded-xl hover:bg-slate-300 transition-all">
                    Keep Review
                </button>
                <button onclick="confirmDeleteReview(${reviewId})" class="flex-1 bg-red-500 text-white font-bold py-3 px-4 rounded-xl hover:bg-red-600 transition-all">
                    Delete
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Animate in
    setTimeout(() => {
        modal.querySelector('div').classList.remove('scale-95');
        modal.querySelector('div').classList.add('scale-100');
    }, 10);
}

// Confirm delete review
function confirmDeleteReview(reviewId) {
    fetch(`/review/${reviewId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showFurFeastModal('üóëÔ∏è Review Deleted!', 'Your review has been deleted successfully.');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert(data.error || 'Failed to delete review');
        }
    })
    .catch(error => {
        alert('An error occurred. Please try again.');
    });
}
</script>
{% endblock %}